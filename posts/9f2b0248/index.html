<!DOCTYPE html>












  


<html class="theme-next mist use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">






  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.5.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=6.5.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=6.5.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=6.5.0">


  <link rel="mask-icon" href="/images/safari_pinned_tab.svg?v=6.5.0" color="#222">


  <link rel="manifest" href="/images/manifest.json">


  <meta name="msapplication-config" content="/images/browserconfig.xml">







<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '6.5.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":true},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="网络层(网际层)提供的两种服务虚电路服务:虚电路表示这只是一条逻辑上的连接,分组都沿着这条选定的逻辑连接按照存储转发方式传送,而并不是真正建立了一条物理连接.电路交换的电话通信是先建立了一条真正的物理连接. 数据报服务:网络层向上只提供简单灵活的,无连接的,尽最大努力交付的数据报服务,网络在发送分组时不需要先建立连接.每一个分组(即IP数据报)独立发送,与其前后的分组无关(不进行编号).网络层不提">
<meta name="keywords" content="computer-network">
<meta property="og:type" content="article">
<meta property="og:title" content="CS-computer-network-网络层">
<meta property="og:url" content="https://hitworld.github.io/posts/9f2b0248/index.html">
<meta property="og:site_name" content="w4rd3n">
<meta property="og:description" content="网络层(网际层)提供的两种服务虚电路服务:虚电路表示这只是一条逻辑上的连接,分组都沿着这条选定的逻辑连接按照存储转发方式传送,而并不是真正建立了一条物理连接.电路交换的电话通信是先建立了一条真正的物理连接. 数据报服务:网络层向上只提供简单灵活的,无连接的,尽最大努力交付的数据报服务,网络在发送分组时不需要先建立连接.每一个分组(即IP数据报)独立发送,与其前后的分组无关(不进行编号).网络层不提">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://hitworld.github.io/posts/9f2b0248/3.png">
<meta property="og:image" content="https://hitworld.github.io/posts/9f2b0248/7.png">
<meta property="og:image" content="https://hitworld.github.io/posts/9f2b0248/8.png">
<meta property="og:image" content="https://hitworld.github.io/posts/9f2b0248/9.png">
<meta property="og:image" content="https://hitworld.github.io/posts/9f2b0248/11.png">
<meta property="og:image" content="https://hitworld.github.io/posts/9f2b0248/13.png">
<meta property="og:image" content="https://hitworld.github.io/posts/9f2b0248/14.png">
<meta property="og:image" content="https://hitworld.github.io/posts/9f2b0248/17.png">
<meta property="og:image" content="https://hitworld.github.io/posts/9f2b0248/18.png">
<meta property="og:image" content="https://hitworld.github.io/posts/9f2b0248/19.png">
<meta property="og:image" content="https://hitworld.github.io/posts/9f2b0248/20.png">
<meta property="og:image" content="https://hitworld.github.io/posts/9f2b0248/21.png">
<meta property="og:image" content="https://hitworld.github.io/posts/9f2b0248/23.png">
<meta property="og:image" content="https://hitworld.github.io/posts/9f2b0248/24.png">
<meta property="og:image" content="https://hitworld.github.io/posts/9f2b0248/25.png">
<meta property="og:image" content="https://hitworld.github.io/posts/9f2b0248/27.png">
<meta property="og:image" content="https://hitworld.github.io/posts/9f2b0248/29.png">
<meta property="og:image" content="https://hitworld.github.io/posts/9f2b0248/30.png">
<meta property="og:image" content="https://hitworld.github.io/posts/9f2b0248/31.png">
<meta property="og:image" content="https://hitworld.github.io/posts/9f2b0248/32.png">
<meta property="og:image" content="https://hitworld.github.io/posts/9f2b0248/33.png">
<meta property="og:image" content="https://hitworld.github.io/posts/9f2b0248/34.png">
<meta property="og:image" content="https://hitworld.github.io/posts/9f2b0248/35.png">
<meta property="og:image" content="https://hitworld.github.io/posts/9f2b0248/36.png">
<meta property="og:updated_time" content="2020-07-09T03:20:02.807Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CS-computer-network-网络层">
<meta name="twitter:description" content="网络层(网际层)提供的两种服务虚电路服务:虚电路表示这只是一条逻辑上的连接,分组都沿着这条选定的逻辑连接按照存储转发方式传送,而并不是真正建立了一条物理连接.电路交换的电话通信是先建立了一条真正的物理连接. 数据报服务:网络层向上只提供简单灵活的,无连接的,尽最大努力交付的数据报服务,网络在发送分组时不需要先建立连接.每一个分组(即IP数据报)独立发送,与其前后的分组无关(不进行编号).网络层不提">
<meta name="twitter:image" content="https://hitworld.github.io/posts/9f2b0248/3.png">






  <link rel="canonical" href="https://hitworld.github.io/posts/9f2b0248/">



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>CS-computer-network-网络层 | w4rd3n</title>
  











  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">w4rd3n</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">混吃等死</p>
      
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>友链</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hitworld.github.io/posts/9f2b0248/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="w4rd3n">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/apple-touch-icon.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="w4rd3n">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">CS-computer-network-网络层
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2020-04-06 22:03:03" itemprop="dateCreated datePublished" datetime="2020-04-06T22:03:03+08:00">2020-04-06</time>
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/CS/" itemprop="url" rel="index"><span itemprop="name">CS</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/CS/computer-network/" itemprop="url" rel="index"><span itemprop="name">computer-network</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/posts/9f2b0248/" class="leancloud_visitors" data-flag-title="CS-computer-network-网络层">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">热度：</span>
               
                 <span class="leancloud-visitors-count"></span>
                 <span>℃</span>
             </span>
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">16k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">15 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="网络层-网际层-提供的两种服务"><a href="#网络层-网际层-提供的两种服务" class="headerlink" title="网络层(网际层)提供的两种服务"></a>网络层(网际层)提供的两种服务</h2><p>虚电路服务:虚电路表示这只是一条逻辑上的连接,分组都沿着这条选定的逻辑连接按照存储转发方式传送,而并不是真正建立了一条物理连接.电路交换的电话通信是先建立了一条真正的物理连接.</p>
<p>数据报服务:网络层向上只提供简单灵活的,无连接的,尽最大努力交付的数据报服务,网络在发送分组时不需要先建立连接.每一个分组(即<code>IP</code>数据报)独立发送,与其前后的分组无关(不进行编号).网络层不提供服务质量的承诺,即所传送的分组可能出错,丢失,重复和失序(不按序到达终点),也不保证分组传送的时限.</p>
<img src="/posts/9f2b0248/3.png" title="p3">
<h2 id="网际协议IP"><a href="#网际协议IP" class="headerlink" title="网际协议IP"></a>网际协议IP</h2><p>网际协议<code>IP</code>是<code>TCP/IP</code>体系中两个最主要的协议之一,与<code>IP</code>协议配套使用的还有三个协议:地址解析协议<code>ARP</code>,网际控制报文协议<code>ICMP</code>,网际组管理协议<code>IGMP</code>(这里讨论的IP都是指<code>IPv4</code>).</p>
<h3 id="虚拟互连网络"><a href="#虚拟互连网络" class="headerlink" title="虚拟互连网络"></a>虚拟互连网络</h3><p>将网络互相连接起来要使用一些中间设备,中间设备又称为中间系统或中继系统,有五种不同的中间设备:物理层中继系统-转发器,数据链路层中继系统-网桥或桥接器,网络层中继系统-路由器,网桥和路由器的混合物-桥路器,网络层以上的中继系统-网关.当中继系统是转发器或网桥时(网络层以下),一般并不称之为网络互连,因为这仅仅是把一个网络扩大了,而这仍然是一个网络.</p>
<p>网关由于比较复杂,目前使用得较少.网络互连都是指用路由器进行网络互连和路由选择.许多有关<code>TCP/IP</code>的文献将网络层使用的路由器称为网关.</p>
<p>虚拟互连网络就是逻辑互连网络,互连起来的各种物理网络的异构性本来是客观存在的,利用<code>IP</code>协议就可以使这些性能各异的网络在用户看起来好像是一个统一的网络,这种虚拟互连网络可简称为<code>IP</code>网.</p>
<p>使用虚拟互连网络的好处是:当互联网上的主机进行通信时,就好像在一个网络上通信一样,而看不见互连的各具体的网络异构细节.如果在这种覆盖全球的<code>IP</code>网的上层使用<code>TCP</code>协议,那么就是现在的互联网.</p>
<h3 id="分类的IP地址"><a href="#分类的IP地址" class="headerlink" title="分类的IP地址"></a>分类的IP地址</h3><p>把整个互联网看成为一个单一的,抽象的网络,<code>IP</code>地址就是给每个连接在互联网上的主机(或路由器)分配一个在全世界范围是唯一的<code>32</code>位的标识符.<code>IP</code>地址现在由互联网名字和数字分配机构<code>ICANN</code>进行分配.</p>
<p><code>IP</code>地址是一种分等级的地址结构,<code>IP</code>地址的编址方法:分类的<code>IP</code>地址(最基本的编址方法),子网的划分(对最基本的编址方法的改进),无分类编址方法(构成超网).</p>
<p>分类的<code>IP</code>地址:将<code>IP</code>地址划分为若干个固定类,每一类地址都由两个固定长度的字段组成,一个字段是网络号<code>net-id</code>,它标志主机(或路由器)所连接到的网络;另一个字段是主机号<code>host-id</code>,它标志该主机(或路由器).通常<code>IP</code>使用点分十进制表示:<code>192.168.235.131</code>.路由器仅根据目的主机所连接的网络号来转发分组,减小了路由表所占的存储空间.</p>
<img src="/posts/9f2b0248/7.png" title="p7">
<img src="/posts/9f2b0248/8.png" title="p8">
<img src="/posts/9f2b0248/9.png" title="p9">
<p>实际上<code>IP</code>地址是标志一个主机(或路由器)和一条链路的接口,当一个主机同时连接到两个网络上时,该主机就必须同时具有两个相应的<code>IP</code>地址,这种主机称为多归属主机.由于一个路由器至少应当连接到两个网络,因此一个路由器至少应当有两个不同的<code>IP</code>地址.两个路由器直接相连的接口处,可指明也可不指明<code>IP</code>地址.如指明<code>IP</code>地址,则这一段连线就构成了一种只包含一段线路的特殊网络.现在常不指明<code>IP</code>地址.</p>
<p>用转发器或网桥连接起来的若干个局域网仍为一个网络,因此这些局域网都具有同样的网络号<code>net-id</code>.</p>
<h3 id="IP地址与硬件地址"><a href="#IP地址与硬件地址" class="headerlink" title="IP地址与硬件地址"></a>IP地址与硬件地址</h3><p><code>IP</code>地址与硬件地址是不同的地址,从层次的角度看:硬件地址(或物理地址)是数据链路层和物理层使用的地址,<code>IP</code>地址是网络层和以上各层使用的地址,是一种用软件实现的逻辑地址.</p>
<img src="/posts/9f2b0248/11.png" title="p11">
<h3 id="地址解析协议ARP"><a href="#地址解析协议ARP" class="headerlink" title="地址解析协议ARP"></a>地址解析协议ARP</h3><p><code>ARP</code>作用:由网络层使用的<code>IP</code>地址解析出在数据链路层使用的硬件地址.每一个主机都设有一个<code>ARP</code>高速缓存,里面有所在的局域网上的各主机和路由器的<code>IP</code>地址到硬件地址的映射表.</p>
<img src="/posts/9f2b0248/13.png" title="p13">
<p>当主机<code>A</code>欲向本局域网上的某个主机<code>B</code>发送<code>IP</code>数据报时,先在<code>ARP</code>高速缓存中查看有无主机<code>B</code>的<code>IP</code>地址,有就将其对应的硬件地址写入<code>MAC</code>帧,然后通过局域网将该<code>MAC</code>帧发往此硬件地址.没有的话<code>ARP</code>进程会在本局域网上广播发送一个<code>ARP</code>请求分组.收到<code>ARP</code>响应分组后,将得到的<code>IP</code>地址到硬件地址的映射写入<code>ARP</code>高速缓存.从<code>IP</code>地址到硬件地址的解析是<code>ARP</code>进程自动进行的.</p>
<p><code>ARP</code>请求分组:包含发送方硬件地址,发送方<code>IP</code>地址,目标方硬件地址(未知时填<code>0</code>),目标方<code>IP</code>地址.</p>
<p><code>ARP</code>响应分组:包含发送方硬件地址,发送方<code>IP</code>地址,目标方硬件地址,目标方<code>IP</code>地址.</p>
<p><code>ARP</code>分组封装在物理网络的帧中传输.本地广播<code>ARP</code>请求(路由器不转发<code>ARP</code>请求),如果所要找的主机和源主机不在同一个局域网上,那么就要通过<code>ARP</code>找到一个位于本局域网上的某个路由器的硬件地址,然后把分组发送给这个路由器,让这个路由器把分组转发给下一个网络.剩下的工作就由下一个网络来做.</p>
<h3 id="IP数据报的格式"><a href="#IP数据报的格式" class="headerlink" title="IP数据报的格式"></a>IP数据报的格式</h3><p><code>IP</code>数据报由首部和数据两部分组成.首部的前一部分是固定长度,共<code>20</code>字节,是所有<code>IP</code>数据报必须具有的.后面是一些可选字段,其长度是可变的.</p>
<img src="/posts/9f2b0248/14.png" title="p14">
<ul>
<li>版本占<code>4bit</code>,<code>IPv4</code>版本号为<code>4</code>.</li>
<li>首部长度占<code>4bit</code>,最大数值为<code>15</code>个单位,一个单位表示<code>4byte</code>,因此<code>IP</code>数据包的首部长度最大为<code>60byte</code>.</li>
<li>区分服务占<code>8bit</code>,旧标准叫做服务类型,但一直没被使用,<code>1998</code>年改为区分服务,只有在使用区分服务时该字段才起作用.</li>
<li>总长度占<code>16bit</code>,指首部与数据之和的长度,单位为字节,因此数据包最大长度为<code>65535</code>字节,且总长度不能超过<code>MTU</code>.</li>
<li>标识占<code>16bit</code>,是一个计数器,用来产生<code>IP</code>数据包的标识.</li>
<li>标志占<code>3bit</code>,目前只有前两位有意义.标志字段的最低位是<code>MF</code>,<code>MF=1</code>表示后面还有分片,<code>MF=0</code>表示这是最后一个分片.中间位是<code>DF</code>,<code>DF=0</code>才允许分片.</li>
<li>片偏移占<code>13bit</code>,指该分片在原分组中的相对位置,以<code>8byte</code>为偏移单位.</li>
<li>生存时间占<code>8bit</code>,记为<code>TTL</code>,指示数据报在网络中可通过的路由器数的最大值.</li>
<li>协议占<code>8bit</code>,指出该数据报的数据使用的协议类型,以便目的主机的<code>IP</code>层将数据部分向上传递.<code>IP</code>协议支持多种协议,可以封装多种协议的<code>PDU</code>,例如:<code>ICMP</code>,<code>IGMP</code>,<code>TCP</code>,<code>UDP</code>,<code>OSPF</code>.</li>
<li>首部检验和<code>16bit</code>,只检验数据报的首部,采用的是<code>16bit</code>二进制反码求和算法.</li>
<li>源地址和目的地址各占<code>32bit</code>.</li>
<li>可变部分用于支持排错,测量以及安全等措施,最长<code>40</code>个字节,会被填充对齐到<code>4byte</code>.</li>
</ul>
<h3 id="IP层转发的流程"><a href="#IP层转发的流程" class="headerlink" title="IP层转发的流程"></a>IP层转发的流程</h3><p>路由器按主机所在的网络地址来制作路由表.根据目的网络地址就能确定下一跳路由器,<code>IP</code>数据报最终一定可以找到目的主机所在目的网络上的路由器(可能要通过多次的间接交付),只有到达最后一个路由器时才试图向目的主机进行直接交付.</p>
<p>虽然互联网所有的分组转发都是基于目的主机所在的网络,但在大多数情况下都允许有这样的特例,即为特定的目的主机指明一个路由.采用特定主机路由可使网络管理人员能更方便地控制网络和测试网络,同时也可在需要考虑某种安全问题时采用这种特定主机路由.</p>
<p>路由器还可采用默认路由以减少路由表所占用的空间和搜索路由表所用的时间,这种转发方式在一个网络只有很少的对外连接时是很有用的.默认路由在主机发送<code>IP</code>数据报时往往更有优势,如果一个主机连接在一个小网络上,而这个网络只用一个路由器和互联网连接,那么在这种情况下使用默认路由是非常合适的.</p>
<p>当路由器收到待转发的数据报,将下一跳路由器的<code>IP</code>地址送交下层的网络接口软件,网络接口软件使用<code>ARP</code>将下一跳路由器的<code>IP</code>地址转换成硬件地址并将此硬件地址放在链路层的<code>MAC</code>帧的首部,然后根据硬件地址找到下一跳路由器.</p>
<h4 id="路由器分组转发算法"><a href="#路由器分组转发算法" class="headerlink" title="路由器分组转发算法"></a>路由器分组转发算法</h4><ol>
<li>从数据报的首部提取目的主机的<code>IP</code>地址<code>D</code>,得出目的网络地址为<code>N</code>.</li>
<li>若网络<code>N</code>与此路由器直接相连,则把数据报直接交付目的主机<code>D</code>;否则下一步.</li>
<li>若路由表中有目的地址为<code>D</code>的特定主机路由,则把数据报传送给路由表中所指明的下一跳路由器;否则下一步.</li>
<li>若路由表中有到达网络<code>N</code>的路由,则把数据报传送给路由表指明的下一跳路由器;否则下一步.</li>
<li>若路由表中有一个默认路由,则把数据报传送给路由表中所指明的默认路由器;否则报告转发分组出错.</li>
</ol>
<h2 id="划分子网和构造超网"><a href="#划分子网和构造超网" class="headerlink" title="划分子网和构造超网"></a>划分子网和构造超网</h2><h3 id="划分子网"><a href="#划分子网" class="headerlink" title="划分子网"></a>划分子网</h3><p>从<code>1985</code>年起在<code>IP</code>地址中又增加了一个子网号字段,使两级的<code>IP</code>地址变成为三级的<code>IP</code>地址.这种做法叫做划分子网,已成为互联网的正式标准协议.划分子网纯属一个单位内部的事情,单位对外仍然表现为没有划分子网的网络.从主机号借用若干个位作为子网号<code>subnet-id</code>,而主机号<code>host-id</code>也就相应减少了若干个位.</p>
<img src="/posts/9f2b0248/17.png" title="p17">
<p>凡是从其他网络发送给本单位某个主机的<code>IP</code>数据报,仍然是根据<code>IP</code>数据报的目的网络号<code>net-id</code>,先找到连接在本单位网络上的路由器,然后此路由器在收到<code>IP</code>数据报后,再按目的网络号和子网号找到目的子网.最后将<code>IP</code>数据报直接交付目的主机.</p>
<img src="/posts/9f2b0248/18.png" title="p18">
<p>子网掩码长度为<code>32</code>位,左边部分的一连串<code>1</code>对应网络号和子网号,右边部分的一连串<code>0</code>对应主机号.通过<code>IP</code>地址与子网掩码进行<code>&amp;</code>运算获得网络地址(包括网络号和子网号).</p>
<p>子网掩码是一个网络或一个子网的重要属性,路由器在和相邻路由器交换路由信息时,必须把自己所在网络(或子网)的子网掩码告诉相邻路由器.路由器的路由表中的每一个项目,除了要给出目的网络地址外,还必须同时给出该网络的子网掩码.若一个路由器连接在两个子网上,就拥有两个网络地址和两个子网掩码.</p>
<p>有固定长度子网和变长子网两种子网划分方法.在采用固定长度子网时,所划分的所有子网的子网掩码都是相同的.划分子网增加了灵活性,但却减少了能够连接在网络上的主机总数.</p>
<p>根据已成为互联网标准协议的<code>RFC 950</code>文档,子网号不能为全<code>1</code>或全<code>0</code>,但随着无分类域间路由选择<code>CIDR</code>的广泛使用,现在全<code>1</code>和全<code>0</code>的子网号也可以使用了,但一定要谨慎使用,确认路由器所用的路由选择软件是否支持全<code>0</code>或全<code>1</code>的子网号用法.</p>
<h3 id="使用子网时分组的转发"><a href="#使用子网时分组的转发" class="headerlink" title="使用子网时分组的转发"></a>使用子网时分组的转发</h3><p>在划分子网的情况下,从<code>IP</code>地址却不能唯一地得出网络地址来,因此分组转发的算法也必须做相应的改动.</p>
<ol>
<li>从收到的分组的首部提取目的<code>IP</code>地址<code>D</code>.</li>
<li>先用连接的各网络的子网掩码和<code>D</code>逐位相与,看是否和相应的网络地址匹配.若匹配,则将分组直接交付;否则下一步.</li>
<li>若路由表中有目的地址为<code>D</code>的特定主机路由,则将分组传送给指明的下一跳路由器;否则下一步.</li>
<li>对路由表中的每一行,将子网掩码和<code>D</code>逐位相与.若结果与该行的目的网络地址匹配,则将分组传送给该行指明的下一跳路由器;否则下一步.</li>
<li>若路由表中有一个默认路由,则将分组传送给路由表中所指明的默认路由器;否则报告转发分组出错.</li>
</ol>
<h3 id="无分类编址CIDR-构造超网"><a href="#无分类编址CIDR-构造超网" class="headerlink" title="无分类编址CIDR(构造超网)"></a>无分类编址CIDR(构造超网)</h3><p>使用变长子网掩码<code>VLSM</code>可进一步提高<code>IP</code>地址资源的利用率,在<code>VLSM</code>的基础上又进一步研究出无分类编址方法,正式名字是无分类域间路由选择<code>CIDR</code>.</p>
<img src="/posts/9f2b0248/19.png" title="p19">
<p><code>CIDR</code>消除了传统的<code>A</code>类,<code>B</code>类和<code>C</code>类地址以及划分子网的概念,使用各种长度的网络前缀来代替分类地址中的网络号和子网号.<code>CIDR</code>使用斜线记法,在<code>IP</code>地址面加上一个斜线<code>/</code>,然后写上网络前缀所占的位数.例如:<code>220.78.168.0/24</code>.<code>CIDR</code>把网络前缀都相同的连续的<code>IP</code>地址组成<code>CIDR</code>地址块,全<code>1</code>或全<code>0</code>的主机号地址一般不使用.</p>
<p>一个<code>CIDR</code>地址块可以表示很多地址,这种地址的聚合常称为路由聚合,路由聚合也称为构成超网.<code>CIDR</code>虽然不使用子网了,但仍然使用掩码(不叫子网掩码),<code>/20</code>的掩码是<code>20</code>个连续的<code>1</code>,斜线记法中的数字就是掩码中<code>1</code>的个数.</p>
<p>网络前缀的后面加一个星号<code>*</code>的表示方法,如<code>0000101000*</code>,在星号之前是网络前缀,而星号表示<code>IP</code>地址中的主机号,可以是任意值.前缀长度不超过<code>23</code>位的<code>CIDR</code>地址块都包含了多个<code>C</code>类地址,这些<code>C</code>类地址合起来就构成了超网.</p>
<p>使用<code>CIDR</code>时,路由表中的每个项目由网络前缀和下一跳地址组成,在查找路由表时可能会得到不止一个匹配结果.应当从匹配结果中选择具有最长网络前缀的路由,即最长前缀匹配.网络前缀越长,其地址块就越小,因而路由就越具体.最长前缀匹配又称为最长匹配或最佳匹配.</p>
<h2 id="IP地址的获取与配置"><a href="#IP地址的获取与配置" class="headerlink" title="IP地址的获取与配置"></a>IP地址的获取与配置</h2><img src="/posts/9f2b0248/20.png" title="p20">
<p>由系统管理员在文件中硬编码或者通过动态主机配置协议<code>DHCP</code>动态地从服务器得到<code>IP</code>地址.</p>
<p>当路由表的项目数很大时,为了进行更加有效的查找,通常将无分类编址的路由表存放在一种层次的数据结构中,然后自上而下地按层次进行查找.最常用的就是二叉线索.<code>IP</code>地址中从左到右的比特值决定了从根结点逐层向下层延伸的路径,而二叉线索中的各个路径就代表路由表中存放的各个地址.为了提高二叉线索的查找速度,广泛使用了各种压缩技术.</p>
<h2 id="网际控制报文协议ICMP"><a href="#网际控制报文协议ICMP" class="headerlink" title="网际控制报文协议ICMP"></a>网际控制报文协议ICMP</h2><p><code>ICMP</code>是互联网的标准协议,允许主机或路由器报告差错情况和提供有关异常情况的报告.<code>ICMP</code>不是高层协议,而是网络层的协议.但是<code>ICMP</code>报文是装在<code>IP</code>数据报中,作为其中的数据部分.</p>
<img src="/posts/9f2b0248/21.png" title="p21">
<p><code>ICMP</code>报文的种类有两种,即<code>ICMP</code>差错报告报文和<code>ICMP</code>询问报文.</p>
<p><code>ICMP</code>差错报告报文的类型:终点不可达,时间超过,参数问题,改变路由(重定向).对<code>ICMP</code>差错报告报文不再发送<code>ICMP</code>差错报告报文,对第一个分片的数据报片的所有后续数据报片都不发送<code>ICMP</code>差错报告报文,对具有多播地址的数据报都不发送<code>ICMP</code>差错报告报文,对具有特殊地址(如<code>127.0.0.0</code>或<code>0.0.0.0</code>)的数据报不发送<code>ICMP</code>差错报告报文.</p>
<p><code>ICMP</code>询问报文的类型:回送请求和回答报文,时间戳请求和回答报文.以下几种<code>ICMP</code>报文不再使用:信息请求与回答报文,掩码地址请求和回答报文,路由器询间和通告报文,源点抑制报文.</p>
<p><code>PING</code>工具使用<code>ICMP</code>回送请求与回送回答报文实现,<code>traceroute/tracert</code>用来跟踪一个分组从源点到终点的路径,它利用<code>IP</code>数据报中的<code>TTL</code>字段和<code>ICMP</code>时间超过差错报告报文实现对从源点到终点的路径的跟踪.</p>
<h2 id="互联网的路由选择协议"><a href="#互联网的路由选择协议" class="headerlink" title="互联网的路由选择协议"></a>互联网的路由选择协议</h2><h3 id="有关路由选择的几个基本概念"><a href="#有关路由选择的几个基本概念" class="headerlink" title="有关路由选择的几个基本概念"></a>有关路由选择的几个基本概念</h3><p>路由选择是是网络中的所有结点共同协调工作的结果,且路由选择的环境往往是不断变化的,而这种变化有时无法事先知道.从路由算法的自适应性考虑可分为静态路由选择策略(非自适应路由选择)和动态路由选择策略(自适应路由选择).</p>
<p>互联网采用分层次的路由选择协议,通过自治系统<code>AS</code>减小处理粒度.自治系统<code>AS</code>指在单一的技术管理下的一组路由器,这些路由器使用一种<code>AS</code>内部的路由选择协议和共同的度量以确定分组在该<code>AS</code>内的路由,同时还使用一种<code>AS</code>之间的路由选择协议用以确定分组在AS之间的路由.一个<code>AS</code>对其他<code>AS</code>表现出的是一个单一的和一致的路由选择策略.</p>
<p>互联网有两大类路由选择协议:内部网关协议<code>IGP</code>,用于<code>AS</code>内部的路由信息传递(域内路由选择),如<code>RIP</code>和<code>OSPF</code>协议;外部网关协议<code>EGP</code>,用于不同<code>AS</code>之间路由信息的传递(域间路由选择),目前使用最多的是<code>BGP-4</code>.</p>
<h3 id="内部网关协议RIP"><a href="#内部网关协议RIP" class="headerlink" title="内部网关协议RIP"></a>内部网关协议RIP</h3><p><code>RIP</code>是一种分布式的,基于距离向量的路由选择协议.<code>RIP</code>协议要求网络中的每一个路由器都要维护从它自己到其他每一个目的网络的距离记录.</p>
<p>从一个路由器到直接连接的网络的距离定义为<code>1</code>,从一个路由器到非直接连接的网络的距离定义为所经过的路由器数加<code>1</code>,<code>RIP</code>协议中的距离也称为跳数,这里的距离指的是”最短距离”.<code>RIP</code>认为一个好的路由就是它通过的路由器的数目少,即距离短.<code>RIP</code>允许一条路径最多只能包含<code>15</code>个路由器,距离的最大值为<code>16</code>时即相当于不可达.<code>RIP</code>不能在两个网络之间同时使用多条路由,<code>RIP</code>选择一个具有最少路由器的路由,即最短路由,而不是最快路由.</p>
<p><code>RIP</code>协议的三个特点:仅和相邻路由器交换信息;交换的信息是当前本路由器所知道的全部信息,即自己的路由表;按固定的时间间隔交换路由信息,或者当网络拓扑发生变化时,路由器也及时向相邻路由器通告拓扑变化后的路由信息.</p>
<p>路由器在刚刚开始工作时,只知道到直接连接的网络的距离(为<code>1</code>),路由表是空的.以后,每一个路由器也只和数目非常有限的相邻路由器交换并更新路由信息,经过若干次更新后,所有的路由器最终都会知道到达本自治系统中任何一个网络的最短距离和下一跳路由器的地址.这个过程称为<code>RIP</code>协议的收敛过程,是较快的.</p>
<p>距离向量算法的基础就是<code>Bellman-Ford</code>算法.要点:<code>X</code>是结点<code>A</code>到<code>B</code>的最短路径上的一个结点,<code>A-&gt;X</code>和<code>X-&gt;B</code>也都分别是结点<code>A</code>到<code>X</code>和结点<code>X</code>到<code>B</code>的最短路径.</p>
<ol>
<li>路由器收到相邻路由器(其地址为<code>X</code>)的一个<code>RIP</code>报文,先修改此<code>RIP</code>报文中的所有顶目:把下一跳字段中的地址都改为<code>X</code>,并把所有的距离字段的值加<code>1</code>.</li>
<li>对修改后的<code>RIP</code>报文中的每一个顶目重复:若项目中的目的网络不在路由表中,则把该项目加到路由表中;若下一跳字段给出的路由器地址是同样的,则把收到的顶目替换原路由表中的顶目;若收到项目中的距离小于路由表中的距离,则进行更新;否则什么也不做.</li>
<li>若<code>3</code>分钟还没有收到相邻路由器的更新路由表,则把此相邻路由器记为不可达路由器,即将距离置为<code>16</code>.</li>
</ol>
<p><code>RIP</code>协议让互联网中的所有路由器都和自己的相邻路由器不断交换路由信息(<code>30</code>秒一次),并不断更新其路由表,使得从每一个路由器到每一个目的网络的路由都是最短的.</p>
<img src="/posts/9f2b0248/23.png" title="p23">
<p><code>RIP2</code>协议的报文格式.<code>RIP2</code>报文由首部和路由部分组成,路由部分由若干个路由信息组成.每个路由信息需要用<code>20</code>个字节,地址族标识符(又称为地址类别)字段用来标志所使用的地址协议.路由标记填入自治系统的号码,再后面指出某个网络地址,该网络的子网掩码,下一跳路由器地址以及到此网络的距离.一个<code>RIP</code>报文最多可包括<code>25</code>个路由,因而<code>RIP</code>报文的最大长度是<code>504</code>字节. <code>RIP2</code>具有简单的鉴别功能:将原来写入第一个路由信息(<code>20</code>个字节)的位置用作鉴别,这时最多只能再放入<code>24</code>个路由信息.</p>
<p><code>RIP</code>协议特点:好消息传播得快,坏消息传播得慢.当网络出现故障时要经过比较长的时间(例如数分钟)才能将此信息传送到所有的路由器.</p>
<h3 id="内部网关协议OSPF"><a href="#内部网关协议OSPF" class="headerlink" title="内部网关协议OSPF"></a>内部网关协议OSPF</h3><p>开放最短路径优先<code>OSPF</code>,使用了<code>Dijkstra</code>提出的最短路径算法<code>SPF</code>,采用分布式的链路状态协议.</p>
<p><code>OSPF</code>使用洪泛法向本自治系统中所有路由器发送信息,发送的信息就是与本路由器相邻的所有路由器的链路状态,但这只是路由器所知道的部分信息.链路状态就是说明本路由器都和哪些路由器相邻,以及该链路的度量.只有当链路状态发生变化时,路由器才用洪泛法向所有路由器发送此信息.所有的路由器最终都能建立一个链路状态数据库.这个数据库实际上就是全网的拓扑结构图,它在全网范围内是一致的(这称为链路状态数据库的同步).<code>OSPF</code>的链路状态数据库能较快地进行更新,使各个路由器能及时更新其路由表.<code>OSPF</code>的更新过程收敛得快是其重要优点.</p>
<p>为了使<code>OSPF</code>能够用于规模很大的网络,<code>OSPF</code>将一个自治系统再划分为若干个更小的范围,叫做区域.每一个区域都有一个<code>32</code>位的区域标识符(用点分十进制表示).区域也不能太大,在一个区域内的路由器最好不超过<code>200</code>个.在一个区域内部的路由器只知道本区域的完整网络拓扑,而不知道其他区域的网络拓扑的情况.</p>
<p><code>OSPF</code>使用层次结构的区域划分,在上层的区域叫做主干区域/骨干区域,标识符规定为<code>0.0.0.0</code>.作用是用来连通其他在下层的区域.<code>OSPF</code>不用<code>UDP</code>而是直接用<code>IP</code>数据报传送,所以构成的数据报很短,从而减少路由信息的通信量,也可以不必将长的数据报分片传送,分片传送的数据报只要丢失一个,就无法组装成原来的数据报,整个数据报必须重传.</p>
<p><code>OSPF</code>对不同的链路可根据<code>IP</code>分组的不同服务类型<code>TOS</code>而设置成不同的代价.因此,<code>OSPF</code>对于不同类型的业务可计算出不同的路由.如果到同一个目的网络有多条相同代价的路径,那么可以将通信量分配给这几条路径,这叫做多路径间的负载平衡.</p>
<p>所有在<code>OSPF</code>路由器之间交换的分组都具有鉴别的功能,<code>OSPF</code>支持可变长度的子网划分和无分类编址<code>CIDR</code>.每一个链路状态都带上一个<code>32</code>位的序号,序号越大状态就越新.</p>
<img src="/posts/9f2b0248/24.png" title="p24">
<img src="/posts/9f2b0248/25.png" title="p25">
<p><code>OSPF</code>有五种分组类型:问候(<code>Hello</code>)分组,数据库描述分组,链路状态请求分组,链路状态更新分组,链路状态确认分组.</p>
<p><code>OSPF</code>规定每隔一段时间,如<code>30</code>分钟,要刷新一次数据库中的链路状态.由于一个路由器的链路状态只涉及到与相邻路由器的连通状态,因而与整个互联网的规模并无直接关系.<code>OSPF</code>没有坏消息传播得慢的问题.多点接入的局域网采用了指定的路由器的方法,使广播的信息量大大减少.指定的路由器代表该局域网上所有的链路向连接到该网络上的各路由器发送状态信息.</p>
<h3 id="外部网关协议BGP"><a href="#外部网关协议BGP" class="headerlink" title="外部网关协议BGP"></a>外部网关协议BGP</h3><p><code>BGP</code>是不同自治系统的路由器之间交换路由信息的协议,对于自治系统之间的路由选择,要寻找最佳路由是很不现实的.当一条路径通过几个不同<code>AS</code>时,要想对这样的路径计算出有意义的代价是不太可能的.比较合理的做法是在<code>AS</code>之间交换可达性信息.自治系统之间的路由选择必须考虑有关策略,<code>BGP</code>只是寻找一条能够到达目的网络且比较好的路由(不能兜圈子).</p>
<p>每一个自治系统的管理员要选择至少一个路由器作为该自治系统的<code>BGP</code>发言人,一般说来,两个<code>BGP</code>发言人都是通过共享网络连接在一起的.而<code>BGP</code>发言人往往就是<code>BGP</code>边界路由器,但也可以不是.一个<code>BGP</code>发言人与其他自治系统中的<code>BGP</code>发言人要交换路由信息,就要先建立<code>TCP</code>连接,然后在此连接上交换<code>BGP</code>报文以建立<code>BGP</code>会话,利用<code>BGP</code>会话交换路由信息,两者彼此成为对方的邻站或对等站.</p>
<p><code>BGP</code>所交换的网络可达性的信息就是要到达某个网络所要经过的一系列<code>AS</code>,<code>BGP</code>协议交换路由信息的结点数量级是自治系统数的量级,这要比这些自治系统中的网络数少很多.每一个自治系统中<code>BGP</code>发言人的数目是很少的.这样就使得自治系统之间的路由选择不致过分复杂.</p>
<p><code>BGP</code>支持<code>CIDR</code>,因此<code>BGP</code>的路由表也就应当包括目的网络前缀,下一跳路由器,以及到达该目的网络所要经过的各个自治系统序列.在<code>BGP</code>刚刚运行时,<code>BGP</code>的邻站是交换整个的<code>BGP</code>路由表.但以后只需要在发生变化时更新有变化的部分.</p>
<p><code>BGP-4</code>的报文类型.</p>
<ol>
<li>打开(<code>OPEN</code>)报文,用来与相邻的另一个<code>BGP</code>发言人建立关系.</li>
<li>更新(<code>UPDATE</code>)报文,用来发送某一路由的信息,以及列出要撤消的多条路由.</li>
<li>保活(<code>KEEPALIVE</code>)报文,用来确认打开报文和周期性地证实邻站关系.</li>
<li>通知(<code>NOTIFICATION</code>)报文,用来发送检测到的差错.</li>
</ol>
<h3 id="路由器的构成"><a href="#路由器的构成" class="headerlink" title="路由器的构成"></a>路由器的构成</h3><p>路由器是一种典型的网络层设备,是一种具有多个输入端口和多个输出端口的专用计算机,其任务是将某个输入端口收到的分组,按照分组要去的目的地,把该分组从某个合适的输出端口转发给下一跳路由器.所以路由器的主要作用是:连通不同的网络,选择信息传送的线路,转发分组.这正是网络层的主要工作.</p>
<img src="/posts/9f2b0248/27.png" title="p27">
<p>整个的路由器结构可划分路由选择部分和分组转发部分.路由选择部分也叫做控制部分,其核心构件是路由选择处理机,其任务是根据所选定的路由选择协议构造出路由表,同时经常或定期地和相邻路由器交换路由信息而不断地更新和维护路由表.分组转发部分由三部分组成:交换结构(根据转发表对分组进行处理),一组输入端口和一组输出端口.</p>
<p>转发就是路由器根据转发表将用户的<code>IP</code>数据报从合适的端口转发出去;路由选择则是按照分布式算法,根据从各相邻路由器得到的关于网络拓扑的变化情况,动态地改变所选择的路由.路由表是根据路由选择算法得出的,而转发表是从路由表得出的.</p>
<p>输入端口里面装有物理层,数据链路层和网络层的处理模块.数据链路层剥去帧首部和尾部后,将分组送到网络层的队列中排队等待处理,这会产生一定的时延.输入端口中的查找和转发功能在路由器的交换功能中是最重要的.</p>
<p>输出端口里有物理层,数据链路层和网络层的处理模块.输出端口从交换结构接收分组,然后把它们发送到路由器外面的线路上.在网络层的处理模块中设有一个缓冲区,当交换结构传送过来的分组的速率超过输出链路的发送速率时,来不及发送的分组就必须暂时存放在这个队列中.数据链路层处理模块将分组加上链路层的首部和尾部,交给物理层后发送到外部线路.</p>
<p>若路由器处理分组的速率赶不上分组进入队列的速率,则队列的存储空间最终必定减少到零,这就使后面再进入队列的分组由于没有存储空间而只能被丢弃.路由器中的输入或输出队列产生溢出是造成分组丢失的重要原因.</p>
<p>交换结构是路由器的关键构件,交换结构把分组从一个输入端口转移到某个合适的输出端口.常用交换方法有三种:通过存储器,通过总线,通过纵横交换结构.</p>
<p>通过存储器:输入端口收到一个分组时就用中断方式通知路由选择处理机,然后分组就从输入端口复制到存储器中,路由器处理机从分组首部提取目的地址,查找路由表,再将分组复制到合适的输出端口的缓存中,若存储器的带宽为每秒<code>M</code>个分组,那么路由器的交换速率(即分组从输入端口传送到输出端口的速率)一定小于<code>M/2</code>.</p>
<p>通过总线:数据报从输入端口通过共享的总线直接传送到合适的输出端口,因为每一个要转发的分组都要通过这一条总线,因此路由器的转发带宽就受总线速率的限制,现代的技术已经可以将总线的带宽提高到每秒吉比特的速率,因此许多的路由器产品都采用这种通过总线的交换方式.</p>
<p>通过纵横交换结构:这种交换结构常称为互连网络,它有<code>2N</code>条总线,可以使<code>N</code>个输入端口和<code>N</code>个输出端口相连接.</p>
<h2 id="IPv6"><a href="#IPv6" class="headerlink" title="IPv6"></a>IPv6</h2><h3 id="IPv6的基本首部"><a href="#IPv6的基本首部" class="headerlink" title="IPv6的基本首部"></a>IPv6的基本首部</h3><p><code>IPv6</code>仍支持无连接的传送,但将协议数据单元<code>PDU</code>称为分组,<code>IPv6</code>所引进的主要变化:更大的地址空间(<code>32</code>位到<code>128</code>位),扩展的地址层次结构,灵活的首部格式,改进的选项,允许协议继续扩充,支持即插即用(不需要使用<code>DHCP</code>),支持资源的预分配,首部改为<code>8</code>字节对齐.</p>
<p><code>IPv6</code>数据报由两大部分组成:基本首部和有效载荷/净负荷.</p>
<img src="/posts/9f2b0248/29.png" title="p29">
<p><code>IPv6</code>将首部长度变为固定的<code>40</code>字节,首部的字段数只有<code>8</code>个,<code>IPv6</code>对首部中的某些字段进行了如下的更改:取消了首部长度字段;取消了服务类型字段;取消了总长度字段,改用有效载荷长度字段;取消了协议字段,改用下一个首部字段;取消了检验和字段;取消了选项字段,而用扩展首部来实现选项功能;把<code>TTL</code>字段改称为跳数限制字段;</p>
<p>版本占<code>4bit</code>,<code>IPv6</code>为<code>6</code>;通信量类占<code>8bit</code>,用于区分不同<code>IPv6</code>数据报的类别或优先级;流标号占<code>20bit</code>,流是网络从特定源点到特定终点的一系列数据报,所有属于同一个流的数据报都有同样的流标号;有效载荷长度占<code>16bit</code>,它指明<code>IPv6</code>数据报除基本首部以外的字节数,其最大值为<code>64KB</code>;下一个首部占<code>8bit</code>,相当于<code>IPv4</code>的协议字段或可选字段用于指明扩展首部,默认为<code>6</code>,无扩展首部;跳数限制占<code>8bit</code>.</p>
<p><code>IPv6</code>将扩展首部留给路径两端的源站和目的站的主机来处理.数据报途中经过的路由器都不处理这些扩展首部(除了逐跳选项扩展首部).在<code>RFC2460</code>中定义了六种扩展首部:逐跳选项对应<code>0</code>;路由选择对应<code>43</code>;分片对应<code>44</code>;鉴别对应<code>50</code>;封装安全有效载荷对应<code>51</code>;目的站选项对应<code>60</code>;多个扩展首部通过前一个扩展首部的下一个首部指明,规则与上述一致.逐跳选项报头结构有一个扩展报头长度条目指明选项个数.</p>
<h3 id="IPv6的地址"><a href="#IPv6的地址" class="headerlink" title="IPv6的地址"></a>IPv6的地址</h3><p><code>IPv6</code>数据报的目的地址可以是以下三种基本类型地址之一:单播,多播,任播(目的站是一组计算机,但数据报在交付时只交付其中的一个,通常是距离最近的一个).</p>
<p><code>IPv6</code>将实现<code>IPv6</code>的主机和路由器均称为结点,结点可能有多个与链路相连的接口,<code>IPv6</code>地址是分配给结点上面的接口的,一个接口可以有多个单播地址,任何一个地址都可以当作到达该结点的目的地址.</p>
<p><code>IPv6</code>使用冒号十六进制记法,如:<code>68E6:8C64:FFFF:FFFF:0:1180:960A:FFFF</code>.冒号十六进制记法可以允许零压缩:<code>FF05:0:0:0:0:0:0:B3</code>可压缩为<code>FF05::B3</code>.在任一地址中只能使用一次零压缩.冒号十六进制记法可结合使用点分十进制记法的后缀:<code>0:0:0:0:0:0:128.10.2.1</code>.<code>CIDR</code>的斜线表示法仍然可用:<code>12AB:OOOO:OOOO:CD30:0000:0000:0000:0000/60</code>.</p>
<img src="/posts/9f2b0248/30.png" title="p30">
<p>全球单播地址划分方法.</p>
<img src="/posts/9f2b0248/31.png" title="p31">
<h3 id="从IPv4向IPv6过渡"><a href="#从IPv4向IPv6过渡" class="headerlink" title="从IPv4向IPv6过渡"></a>从IPv4向IPv6过渡</h3><p>两种向<code>IPv6</code>过渡的策略:双协议栈;隧道技术.双协议栈是指在完全过渡到<code>IPv6</code>之前,使一部分主机或路由器装有两个协议栈,<code>IPv4</code>和<code>IPv6</code>,同时具有两种<code>IP</code>地址.隧道技术是指在<code>IPv6</code>数据报要进入<code>IPv4</code>网络时,把<code>IPv6</code>数据报封装成为<code>IPv4</code>数据报,整个的<code>IPv6</code>数据报变成了<code>IPv4</code>数据报的数据部分,离开<code>IPv4</code>网络中的隧道时再分离.</p>
<h3 id="ICMPv6"><a href="#ICMPv6" class="headerlink" title="ICMPv6"></a>ICMPv6</h3><p><code>IPv6</code>不保证数据报的可靠交付,也需要使用<code>ICMP</code>来反馈一些差错信息.新的版本称为<code>ICMPv6</code>.地址解析协议<code>ARP</code>和网际组管理协议<code>IGMP</code>协议的功能都已被合并到<code>ICMPv6</code>中.<code>ICMPv6</code>是面向报文的协议,它利用报文来报告差错,获取信息,探测邻站或管理多播通信.<code>ICMPv6</code>还增加了几个定义报文的功能及含义的其他协议.</p>
<img src="/posts/9f2b0248/32.png" title="p32">
<h2 id="IP多播"><a href="#IP多播" class="headerlink" title="IP多播"></a>IP多播</h2><p><code>IP</code>多播目的是更好地支持一对多通信,即一个源点发送到许多个终点.应用场景:实时信息的交付,软件更新等.采用多播方式,只需发送一次到多播组,由路由器复制分组,局域网具有硬件多播功能,不需要复制分组.在互联网上进行多播就叫做<code>IP</code>多播,<code>IP</code>多播靠路由器来实现,能够运行多播协议的路由器称为多播路由器.</p>
<p><code>IP</code>多播所传送的分组需要使用多播<code>IP</code>地址,在多播数据报的目的地址写入的是多播组的标识符.多播组的标识符就是<code>IP</code>地址中的<code>D</code>类地址(多播地址).每一个<code>D</code>类地址标志一个多播组.</p>
<p>多播数据报和一般的<code>IP</code>数据报的区别就是它使用<code>D</code>类<code>IP</code>地址作为目的地址,并且首部中的协议字段值是<code>2</code>,表明使用网际组管理协议<code>IGMP</code>.多播数据报也是尽最大努力交付,不保证一定能够交付多播组内的所有成员.对多播数据报不产生<code>ICMP</code>差错报文.</p>
<p>互联网号码指派管理局<code>IANA</code>拥有的以太网地址块的高<code>24</code>位为<code>00-00-SE</code>.因此<code>TCP/IP</code>协议使用的以太网地址块的范围是:<code>00-00-5E-00-00-00</code>到<code>00-00-5E-FF-FF-FF</code>.在每一个地址中,只有<code>23</code>位可用作多播.<code>D</code>类<code>IP</code>地址可供分配的有<code>28</code>位,在这<code>28</code>位中的前<code>5</code>位不能用来构成以太网硬件地址.由于多播<code>IP</code>地址与以太网硬件地址的映射关系不是唯一的,因此收到多播数据报的主机,还要在<code>IP</code>层利用软件进行过滤,把不是本主机要接收的数据报丢弃.</p>
<img src="/posts/9f2b0248/33.png" title="p33">
<p>多播需要的两种协议:为了使路由器知道多播组成员的信息,需要使用网际组管理协议<code>IGMP</code>.连接在局域网上的多播路由器还必须和互联网上的其他多播路由器协同工作,以便把多播数据报用最小代价传送给所有的组成员,需要使用多播路由选择协议.</p>
<h3 id="IGMP"><a href="#IGMP" class="headerlink" title="IGMP"></a>IGMP</h3><p>和<code>ICMP</code>相似,<code>IGMP</code>使用<code>IP</code>数据报传递其报文,但它也向<code>IP</code>提供服务.不把<code>IGMP</code>看成是一个单独的协议,而是属于整个网际协议<code>IP</code>的一个组成部分.</p>
<ul>
<li>加入多播组:当某个主机加入新的多播组时,该主机应向多播组的多播地址发送<code>IGMP</code>报文.本地的多播路由器收到<code>IGMP</code>报文后,将组成员关系转发给互联网上的其他多播路由器.</li>
<li>探询组成员变化情况:本地多播路由器要周期性地探询本地局域网上的主机,以便知道这些主机是否还继续是组的成员.只要对某个组有一个主机响应,播路由器就认为这个组是活跃的.一个组在经过几次的探询后仍然没有一个主机响应,则不再将该组的成员关系转发给其他的多播路由器.</li>
</ul>
<p>在主机和多播路由器之间的所有通信都是使用<code>IP</code>多播,多播路由器在探询组成员关系时,只需要对所有的组发送一个请求信息的询问报文,默认的询问速率是每<code>125</code>秒发送一次.在<code>IGMP</code>的询问报文中有一个数值<code>N</code>,它指明一个最长响应时间,默认值为<code>10</code>秒,当收到询问时,主机在<code>0</code>到<code>N</code>之间随机选择发送响应所需经过的时延.对应最小时延的响应最先发送.同一个组内的每一个主机都要监听响应,只要有本组的其他主机先发送了响应,自己就可以不再发送响应了.</p>
<h3 id="多播路由选择"><a href="#多播路由选择" class="headerlink" title="多播路由选择"></a>多播路由选择</h3><p>多播路由选择协议尚未标准化.一个多播组中的成员是动态变化的,多播路由选择实际上就是要找出以源主机为根结点的多播转发树,在多播转发树上的路由器不会收到重复的多播数据报,对不同的多播组对应于不同的多播转发树,同一个多播组,对不同的源点也会有不同的多播转发树.</p>
<p>多播路由选择协议在转发多播数据报时使用三种方法.</p>
<ul>
<li>洪泛与剪除,初始路由器转发多播数据报使用洪泛的方法,采用反向路径广播<code>RPB</code>避免兜圈子.</li>
<li>隧道技术,之前提到过,即对于不支持多播的网络会将多播数据报封装.</li>
<li>基于核心的发现技术,对每一个多播组<code>G</code>指定一个核心路由器,给出它的<code>IP</code>单播地址.核心路由器按照前面讲过的方法创建出对应于多播组<code>G</code>的转发树.</li>
</ul>
<p><code>RPB</code>的要点.</p>
<ul>
<li>路由器收到多播数据报时,先检查它是否是从源点经最短路径传送来的.是就向所有其他方向转发刚才收到的多播数据报,否则就丢弃.</li>
<li>如果存在几条同样长度的最短路径,那么只能选择一条最短路径,选择的准则就是看这几条最短路径中的相邻路由器谁的<code>IP</code>地址最小.</li>
<li>最后就得出了用来转发多播数据报的多播转发树,以后就按这个多播转发树转发.</li>
<li>如果在多播转发树上的某个路由器发现它的下游树枝已没有该多播组的成员,就应把它和下游的树枝一起剪除.</li>
<li>当某个树枝有新增加的组成员时,可以再接入到多播转发树上.</li>
</ul>
<p>几种多播路由选择协议:距离向量多播路由选择协议<code>DVMRP</code>,基于核心的转发树<code>CBT</code>,开放最短通路优先的多播扩展<code>MOSPF</code>,协议无关多播-稀疏方式<code>PIM-SM</code>,协议无关多播-密集方式<code>PIM-DM</code>.</p>
<h2 id="虚拟专用网VPN"><a href="#虚拟专用网VPN" class="headerlink" title="虚拟专用网VPN"></a>虚拟专用网VPN</h2><p>本地地址指仅在机构内部使用的<code>IP</code>地址,可以由本机构自行分配,而不需要向互联网的管理机构申请.全球地址,全球唯一的<code>IP</code>地址,必须向互联网的管理机构申请.<code>RFC 1918</code>指明了一些专用地址,专用地址只能用作本地地址而不能用作全球地址.在互联网中的所有路由器,对目的地址是专用地址的数据报一律不进行转发.</p>
<img src="/posts/9f2b0248/34.png" title="p34">
<p>采用这样的专用<code>IP</code>地址的互连网络称为专用互联网或本地互联网,或专用网.因为这些专用地址仅在本机构内部使用,专用<code>IP</code>地址也叫做可重用地址.</p>
<p>使用隧道技术实现利用公用的互联网作为本机构各专用网之间的通信载体,这样的专用网又称为虚拟专用网<code>VPN</code>,专用网是因为这种网络是为本机构的主机用于机构内部的通信,而不是用于和网络外非本机构的主机通信.<code>VPN</code>没有真正使用通信专线,只是在效果上和真正的专用网一样.如果<code>VPN</code>有保密的要求,那么其所有通过互联网传送的数据都会加密.</p>
<p>一个机构要构建自己的<code>VPN</code>就必须为它的每一个场所购买专门的硬件和软件,并进行配置,使每一个场所的<code>VPN</code>系统都知道其他场所的地址.由部门<code>A</code>和<code>B</code>的内部网络所构成的虚拟专用网<code>VPN</code>又称为内联网(<code>intranet</code>).一个机构和某些外部机构共同建立的虚拟专用网<code>VPN</code>又称为外联网(<code>extranet</code>).</p>
<h2 id="网络地址转换NAT"><a href="#网络地址转换NAT" class="headerlink" title="网络地址转换NAT"></a>网络地址转换NAT</h2><p>在专用网上使用专用地址的主机如何与互联网上的主机通信(不需要加密).解决方法:再申请一些全球<code>IP</code>地址;采用网络地址转换<code>NAT</code>.</p>
<p>网络地址转换<code>NAT</code>需要在专用网连接到互联网的路由器上安装<code>NAT</code>软件.装有<code>NAT</code>软件的路由器叫做<code>NAT</code>路由器,它至少有一个有效的外部全球<code>IP</code>地址.</p>
<p>所有使用本地地址的主机在和外界通信时,都要在<code>NAT</code>路由器上将其本地地址转换成全球<code>IP</code>地址,才能和互联网连接.内部主机<code>A</code>用本地地址<code>IPA</code>和互联网上主机<code>B</code>通信所发送的数据报必须经过<code>NAT</code>路由器.<code>NAT</code>路由器将数据报的源地址<code>IPA</code>转换成全球地址<code>IPG</code>,并把转换结果记录到<code>NAT</code>地址转换表中,目的地址<code>IPB</code>保持不变,然后发送到互联网.<code>NAT</code>路由器收到主机<code>B</code>发回的数据报时,知道数据报中的源地址是<code>IPB</code>而目的地址是<code>IPG</code>.根据<code>NAT</code>转换表,<code>NAT</code>路由器将目的地址<code>IPG</code>转换为<code>IPA</code>,转发给最终的内部主机<code>A</code>.</p>
<p>当<code>NAT</code>路由器具有<code>n</code>个全球<code>IP</code>地址时,专用网内最多可以同时有<code>n</code>台主机接入到互联网.通过<code>NAT</code>路由器的通信必须由专用网内的主机发起,专用网内部的主机不能充当服务器用,因为互联网上的客户无法请求专用网内的服务器提供服务.</p>
<p>为了更加有效地利用<code>NAT</code>路由器上的全球<code>IP</code>地址,现在常用的<code>NAT</code>转换表把运输层的端口号也利用上.这样就可以使多个拥有本地地址的主机,共用一个<code>NAT</code>路由器上的全球<code>IP</code>地址.使用端口号的<code>NAT</code>叫做网络地址与端口号转换<code>NAPT</code>.而不使用端口号的<code>NAT</code>就叫做传统的<code>NAT</code>.<code>NAPT</code>可用一个<code>LAN</code>侧地址支持<code>60000</code>并行连接。</p>
<h2 id="多协议标记交换MPLS"><a href="#多协议标记交换MPLS" class="headerlink" title="多协议标记交换MPLS"></a>多协议标记交换MPLS</h2><p><code>MPLS</code>最初是为提高路由器转发速度而提出,多协议表示在<code>MPLS</code>的上层可以采用多种协议.标记是指每个分组被打上一个标记,根据该标记对分组进行转发.</p>
<p>为了实现交换,可以利用面向连接的概念,使每个分组携带一个叫做标记(<code>label</code>)的小整数.当分组到达交换机(即标记交换路由器)时,交换机读取分组的标记,并用标记值来检索分组转发表.<code>MPLS</code>并没有取代<code>IP</code>,而是作为一种<code>IP</code>增强技术,被广泛地应用在互联网中.通过在专网中采用固定长度标记达到改善<code>IP</code>路由器的转发速率的目的,对端系统透明.</p>
<p><code>MPLS</code>具有以下三个方面的特点:支持面向连接的服务质量;支持流量工程,平衡网络负载;有效地支持虚拟专用网<code>VPN</code>.</p>
<p><code>MPLS</code>的工作原理:在<code>MPLS</code>域的入口处,给每一个<code>IP</code>数据报打上固定长度标记,然后对打上标记的<code>IP</code>数据报用硬件进行转发.采用硬件技术对打上标记的<code>IP</code>数据报进行转发就称为标记交换.交换表示在转发时不再上升到第三层查找转发表,而是根据标记在第二层链路层用硬件进行转发.<code>MPLS</code>域是指该域中有许多彼此相邻的路由器,并且所有的路由器都是支持<code>MPLS</code>技术的标记交换路由器<code>LSR</code>.<code>LSR</code>同时具有标记交换和路由选择这两种功能,标记交换功能是为了快速转发,但在这之前<code>LSR</code>需要使用路由选择功能构造转发表.</p>
<p>基本工作过程.</p>
<ol>
<li><code>MPLS</code>域中的各<code>LSR</code>使用专门的标记分配协议<code>LDP</code>交换报文,并找出标记交换路径<code>LSP</code>.各<code>LSR</code>根据这些路径构造出分组转发表.</li>
<li>分组进入到<code>MPLS</code>域时,<code>MPLS</code>入口结点把分组打上标记,并按照转发表将分组转发给下一个<code>LSR</code>.给<code>IP</code>数据报打标记的过程叫做分类.</li>
<li>一个标记仅仅在两个标记交换路由器<code>LSR</code>之间才有意义.分组每经过一个<code>LSR</code>,<code>LSR</code>就要:转发,更换新的标记,即把入标记更换成为出标记.这就叫做标记对换.</li>
<li>当分组离开<code>MPLS</code>域时,<code>MPLS</code>出口结点把分组的标记去除.再以后就按照一般分组的转发方法进行转发.</li>
<li>上述的这种由入口<code>LSR</code>确定进入<code>MPLS</code>域以后的转发路径称为显式路由选择.</li>
</ol>
<img src="/posts/9f2b0248/35.png" title="p35">
<p><code>MPLS</code>有个很重要的概念就是转发等价类<code>FEC</code>,转发等价类就是路由器按照同样方式对待(从同样接口转发到同样的下一跳地址,且具有同祥服务类别和同祥丢弃优先级等)的分组的集合.入口结点并不是给每一个分组指派一个不同的标记,而是将属于同样<code>FEC</code>的分组都指派同样的标记.<code>FEC</code>和标记是一一对应的关系.<code>FEC</code>用于负载平衡,也称为流量工程<code>TE</code>或通信量工程.</p>
<p><code>MPLS</code>并不要求下层的网络都使用面向连接的技术,下层的网络并不提供打标记的手段,而是使用一种封装技术,在把<code>IP</code>数据报封装成以太网帧之前,先插入一个<code>MPLS</code>首部.</p>
<img src="/posts/9f2b0248/36.png" title="p36">
<p>MPLS首部共包括四个字段:标记值;试验,目前保留用作试验;栈<code>s</code>:在有标记栈时使用;生存时间<code>TTL</code>,用来防止<code>MPLS</code>分组在<code>MPLS</code>域中兜圈子.在以太网中使用值是<code>0x8847</code>(单播)和<code>0x8848</code>(组播)来表示承载的是<code>MPLS</code>报文(<code>0800</code>是<code>IP</code>报文）,在<code>PPP</code>中增加了一种新的<code>NCP</code>:<code>MPLSCP</code>,使用<code>0x8281</code>来标识.</p>

      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/computer-network/" rel="tag"><i class="fa fa-tag"></i> computer-network</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/posts/2ec73776/" rel="next" title="CS-computer-network-无线网络和移动网络">
                <i class="fa fa-chevron-left"></i> CS-computer-network-无线网络和移动网络
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/posts/76ab93ca/" rel="prev" title="mathematics-probability-theory-随机变量的数字特征">
                mathematics-probability-theory-随机变量的数字特征 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
      <div id="sidebar-dimmer"></div>
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/apple-touch-icon.png" alt="w4rd3n">
            
              <p class="site-author-name" itemprop="name">w4rd3n</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">188</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">24</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">54</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/hitworld" title="GitHub &rarr; https://github.com/hitworld" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#网络层-网际层-提供的两种服务"><span class="nav-number">1.</span> <span class="nav-text">网络层(网际层)提供的两种服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#网际协议IP"><span class="nav-number">2.</span> <span class="nav-text">网际协议IP</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#虚拟互连网络"><span class="nav-number">2.1.</span> <span class="nav-text">虚拟互连网络</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分类的IP地址"><span class="nav-number">2.2.</span> <span class="nav-text">分类的IP地址</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IP地址与硬件地址"><span class="nav-number">2.3.</span> <span class="nav-text">IP地址与硬件地址</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#地址解析协议ARP"><span class="nav-number">2.4.</span> <span class="nav-text">地址解析协议ARP</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IP数据报的格式"><span class="nav-number">2.5.</span> <span class="nav-text">IP数据报的格式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IP层转发的流程"><span class="nav-number">2.6.</span> <span class="nav-text">IP层转发的流程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#路由器分组转发算法"><span class="nav-number">2.6.1.</span> <span class="nav-text">路由器分组转发算法</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#划分子网和构造超网"><span class="nav-number">3.</span> <span class="nav-text">划分子网和构造超网</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#划分子网"><span class="nav-number">3.1.</span> <span class="nav-text">划分子网</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用子网时分组的转发"><span class="nav-number">3.2.</span> <span class="nav-text">使用子网时分组的转发</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#无分类编址CIDR-构造超网"><span class="nav-number">3.3.</span> <span class="nav-text">无分类编址CIDR(构造超网)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IP地址的获取与配置"><span class="nav-number">4.</span> <span class="nav-text">IP地址的获取与配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#网际控制报文协议ICMP"><span class="nav-number">5.</span> <span class="nav-text">网际控制报文协议ICMP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#互联网的路由选择协议"><span class="nav-number">6.</span> <span class="nav-text">互联网的路由选择协议</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#有关路由选择的几个基本概念"><span class="nav-number">6.1.</span> <span class="nav-text">有关路由选择的几个基本概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#内部网关协议RIP"><span class="nav-number">6.2.</span> <span class="nav-text">内部网关协议RIP</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#内部网关协议OSPF"><span class="nav-number">6.3.</span> <span class="nav-text">内部网关协议OSPF</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#外部网关协议BGP"><span class="nav-number">6.4.</span> <span class="nav-text">外部网关协议BGP</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#路由器的构成"><span class="nav-number">6.5.</span> <span class="nav-text">路由器的构成</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IPv6"><span class="nav-number">7.</span> <span class="nav-text">IPv6</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#IPv6的基本首部"><span class="nav-number">7.1.</span> <span class="nav-text">IPv6的基本首部</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IPv6的地址"><span class="nav-number">7.2.</span> <span class="nav-text">IPv6的地址</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#从IPv4向IPv6过渡"><span class="nav-number">7.3.</span> <span class="nav-text">从IPv4向IPv6过渡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ICMPv6"><span class="nav-number">7.4.</span> <span class="nav-text">ICMPv6</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IP多播"><span class="nav-number">8.</span> <span class="nav-text">IP多播</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#IGMP"><span class="nav-number">8.1.</span> <span class="nav-text">IGMP</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#多播路由选择"><span class="nav-number">8.2.</span> <span class="nav-text">多播路由选择</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#虚拟专用网VPN"><span class="nav-number">9.</span> <span class="nav-text">虚拟专用网VPN</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#网络地址转换NAT"><span class="nav-number">10.</span> <span class="nav-text">网络地址转换NAT</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#多协议标记交换MPLS"><span class="nav-number">11.</span> <span class="nav-text">多协议标记交换MPLS</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-gg-circle"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">w4rd3n</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
    <span title="站点总字数">704k</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
    <span title="站点阅读时长">10:40</span>
  
</div>









        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv" title="总访客量">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="site-pv" title="总访问量">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>














  
    
      
  
  <script type="text/javascript" color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script>













  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.5.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.5.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.5.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.5.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.5.0"></script>



  



  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script>
    
    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();

      Counter('get', '/classes/Counter', { where: JSON.stringify({ url }) })
        .done(function ({ results }) {
          if (results.length > 0) {
            var counter = results[0];
            
            Counter('put', `/classes/Counter/${counter.objectId}`, JSON.stringify({ time: { "__op":"Increment", "amount":1 } }))
            
            .done(function () {
                  var $element = $(document.getElementById(url));
                  $element.find('.leancloud-visitors-count').text(counter.time + 1);
            })
            
            .fail(function ({ responseJSON }) {
                console.log('Failed to save Visitor num, with error message: ' + responseJSON.error);
            })
          } else {
            
              Counter('post', '/classes/Counter', JSON.stringify({ title: title, url: url, time: 1}))
                .done(function () {
                  var $element = $(document.getElementById(url));
                  $element.find('.leancloud-visitors-count').text(1);
                })
                .fail(function () {
                  console.log('Failed to create');
                });
            
          }
        })
      .fail(function ({ responseJSON }) {
        console.log('LeanCloud Counter Error:' + responseJSON.code + " " + responseJSON.error);
      });
    }
    

    $(function() {
      $.get('https://app-router.leancloud.cn/2/route?appId=' + "no3Ip4mNLc3JyF1AeTy8LrAm-gzGzoHsz")
        .done(function ({ api_server }) {
          var Counter = function (method, url, data) {
            return $.ajax({
              method: method,
              url: `https://${api_server}/1.1${url}`,
              headers: {
                'X-LC-Id': "no3Ip4mNLc3JyF1AeTy8LrAm-gzGzoHsz",
                'X-LC-Key': "UvlYMzpJKw0Jrw61V5BA5ifU",
                'Content-Type': 'application/json',
              },
              data: data,
            });
          };
          
          addCount(Counter);
          
        })
    });
  </script>



  

  

  

  

  
  

  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap')
      $(e).after($wrap)
      $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text()
        }).toArray().join('\n')
        var ta = document.createElement('textarea')
        document.body.appendChild(ta)
        ta.style.position = 'absolute'
        ta.style.top = '0px'
        ta.style.left = '0px'
        ta.value = code
        ta.select()
        ta.focus()
        var result = document.execCommand('copy')
        document.body.removeChild(ta)
        
        $(this).blur()
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn')
        setTimeout(function () {
          $b.text('复制')
        }, 300)
      }).append(e)
    })
  </script>


  

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-backstretch/2.0.4/jquery.backstretch.min.js"></script>;
  <script>
  //$("body").backstretch("/images/background.jpg");
  </script>
  
  <script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>
  
<script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false},"log":false});</script></body>
</html>
